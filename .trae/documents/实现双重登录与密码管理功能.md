# 登录方式调整与密码管理实施计划

本计划旨在实现双重登录方式（验证码/密码），并加强密码安全管理。

## 1. 依赖安装
后端引入加密库，用于密码的安全哈希存储。
- `npm install bcryptjs`
- `npm install -D @types/bcryptjs`

## 2. 数据库变更
修改 `users` 表结构，增加密码字段。
- 创建迁移文件 `supabase/migrations/add_password_to_users.sql`。
- 新增字段 `password_hash` (VARCHAR, Nullable)，允许旧用户或仅验证码登录用户无密码。

## 3. 后端 API 开发 (`api/`)
### 3.1 修改认证接口 (`api/routes/auth.ts`)
- 改造 `POST /login` 接口，支持 `type` 参数：
    - `type: 'code'` (默认)：保持原有验证码逻辑。
    - `type: 'password'`：根据手机号查找用户，并使用 `bcrypt.compare` 校验密码。

### 3.2 新增用户管理接口 (`api/routes/users.ts`)
- 新增 `POST /:id/password` 接口：
    - 用于管理员重置指定用户的密码。
    - 接收新密码，使用 `bcrypt.hash` 加密后存入数据库。

## 4. 前端 H5 开发 (`src/h5/`)
### 4.1 登录页改造 (`LoginPage.vue`)
- 引入 Tab 切换组件：
    - **Tab 1: 验证码登录** (保留现有逻辑)。
    - **Tab 2: 密码登录**。
- 密码传输安全：
    - 采用 HTTPS 协议保障传输层安全（标准做法）。
    - 密码在前端保持明文提交，由后端接收后立即进行 Hash 处理。

## 5. 管理端开发 (`src/admin/`)
### 5.1 用户列表改造 (`UserList.vue`)
- 表格增加“操作”列。
- 添加“重置密码”按钮。
- 实现重置密码弹窗：
    - 输入新密码。
    - 调用后端重置接口。

## 验证计划
1.  **验证码登录**：确认旧方式依然可用。
2.  **管理端重置**：在管理端给某用户设置密码。
3.  **密码登录**：使用设置好的密码在 H5 端登录，验证成功。
4.  **错误密码**：验证密码错误时的提示。
