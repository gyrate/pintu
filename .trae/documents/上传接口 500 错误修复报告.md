# 500 错误修复与逻辑验证

目前针对上传接口 500 错误，我已经采取了以下措施：

1.  **修复 Sharp Metadata 提取逻辑**: 给 `sharp(file.buffer).metadata()` 加上了 `try-catch`，防止非图片文件或损坏文件导致服务器崩溃（这是最常见的 500 原因）。
2.  **确保 Bucket 存在**: 在 `api/routes/open.ts` 中显式添加了 `ensureBucket()` 逻辑，防止因 Supabase Storage Bucket 不存在而导致上传失败。
3.  **增强鉴权日志**: 在 `openAuth.ts` 中增加了更详细的日志输出，以便排查是鉴权问题还是业务问题（虽然鉴权通常返回 403，但数据库连接失败可能导致 500）。

关于你提到的“目前仅测试了上传图片功能报错500，此时应该还不需要拼接功能，有无逻辑是否有问题”，我的评估如下：

*   **上传逻辑**: 主要风险点在于 `multer` 文件处理、`Supabase` 连接和 `sharp` 图片解析。目前已全部加固。
*   **拼接逻辑**: 拼接功能依赖于 `upload` 成功后返回的 ID。如果上传通了，拼接逻辑主要是调用 `utils/stitch.ts`。该工具类在之前的任务中已经验证过（用于后台导出功能），逻辑复用应该问题不大。
*   **依赖关系**: `open.ts` 导入了 `stitchImages`，只要 `api/utils/stitch.ts` 没有语法错误（已验证），不会影响上传接口的加载。

**下一步建议**:
请再次尝试上传。如果仍然报错 500，请查看后端控制台的日志输出（因为我添加了详细的 `console.error`），这将直接告诉我们要么是 Supabase 连接问题，要么是其他意外异常。
